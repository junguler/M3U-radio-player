<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M3U Player</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');
    
    * {
      box-sizing: border-box;
      border-radius: 0px;
    }
    
    #track-title {
      margin: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background: #121212;
      color: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 95vh;
    }
    
    .player-container {
      width: 500px;
      background: #1f1f1f;
      padding: 14px;
    }
    
    .now-playing {
      text-align: center;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .controls {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-top: 15px;
    }
    
    .controls button {
      background: #2d2d2d;
      border: none;
      color: #eee;
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .controls button:hover {
      background: #3d3d3d;
    }
    
    .visualizer-container {
      margin-top: 20px;
    }
    
    canvas {
      background: #000;
      width: 100%;
      display: block;
    }
    
    .playlist {
      /* margin-top: 10px; */
      max-height: 200px;
      overflow: auto;
      padding: 10px;
      margin-top: 10px;
      /* border-top: 1px solid #333; */
      /* padding-top: 10px; */
    }
    
    .playlist-item {
      /* padding: 8px 10px; */
      margin-top: 5px;
      background: #2d2d2d;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .playlist-item:hover {
      background: #3d3d3d;
    }
    
    .playing {
      background: #5c5c5c;
      font-weight: bold;
    }

    .fa {
      font-size: 1.5em;
    }
    /* Replace .hidden with .invisible to preserve layout space */
    .invisible {
      visibility: hidden;
    }
    #volume-level {
      display: inline-block;
      width: 50px; /* fixed width to reserve space for "100%" */
      text-align: center;
    }
    .volume-controls {
      display: inline-flex;
      align-items: center;
      gap: 2px; /* adjust gap as desired */
    }
  </style>
</head>
<body>
  <div class="player-container">
    <div class="now-playing">
      <p id="track-title">No playlists loaded</p>
    </div>
    <div class="controls">
      <button id="load-web-btn"><i class="fa fa-globe"></i></button>
      <button id="load-local-btn"><i class="fa fa-folder-open"></i></button>
      <input type="file" id="load-local" accept=".m3u" hidden />
      <button id="prev"><i class="fa fa-step-backward"></i></button>
      <button id="play-pause"><i class="fa fa-play"></i></button>
      <button id="next"><i class="fa fa-step-forward"></i></button>
      <div class="volume-controls">
        <button id="volume-down"><i class="fa fa-volume-down"></i></button>
        <span id="volume-level">50%</span>
        <button id="volume-up"><i class="fa fa-volume-up"></i></button>
      </div>
    </div>
    <div class="visualizer-container">
      <canvas id="visualizer" width="480" height="100"></canvas>
    </div>
    <div class="playlist" id="playlist"></div>
  </div>
  <script>
    let playlist = [
      { url: 'http://stream.dancewave.online:8080/dance.mp3', title: 'Dance Wave!' },
      { url: 'http://80.251.40.4:8089/stream/1/', title: 'ANKARA UNÄ° RADYOSU' },
      { url: 'http://51.89.148.171:8022/stream/1/', title: 'Dance UK Radio danceradiouk' },
      { url: 'http://hirschmilch.de:7000/stream/4/', title: 'Hirschmilch Chillout' },
      { url: 'http://listen.rusongs.ru/ru-mp3-128', title: 'Russkie Pesni' },
      { url: 'http://uk2.streamingpulse.com:8010/stream/1/', title: 'Venice Classic Radio Auditorium' },
      { url: 'http://b.fmradiomanele.ro:8044/stream/1/', title: 'Radio Manele Romania' },
      { url: 'http://stream.funradio.sk:8000/fun128.mp3', title: 'FUN Radio Live' },
      { url: 'http://64.95.243.43:8002/stream/1/', title: 'BEST SMOOTH JAZZ' },
      { url: 'http://streaming.hdserver.biz:9300/stream/1/', title: 'LA SUEGRA FM' }
    ];
    let currentTrackIndex = 0;
    let isPlaying = false;
    const audioElement = new Audio();
    audioElement.crossOrigin = "anonymous";
    audioElement.volume = 0.5;
    
    // Setup Web Audio API for visualizer
    const canvas = document.getElementById('visualizer');
    const canvasCtx = canvas.getContext('2d');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    
    // Create a MediaElementAudioSourceNode to use the audio stream
    const source = audioCtx.createMediaElementSource(audioElement);
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    
    // New helper function to return gradient color
    function getGradientColor(ratio) {
      let r, g, b;
      if (ratio <= 0.5) {
        // interpolate from yellow (255,255,0) to magenta (255,0,255)
        const t = ratio / 0.5;
        r = 255;
        g = Math.round(255 * (1 - t));
        b = Math.round(255 * t);
      } else {
        // interpolate from magenta (255,0,255) to cyan (0,255,255)
        const t = (ratio - 0.5) / 0.5;
        r = Math.round(255 * (1 - t));
        g = Math.round(255 * t);
        b = 255;
      }
      return 'rgb(' + r + ',' + g + ',' + b + ')';
    }
    
    function drawVisualizer() {
      requestAnimationFrame(drawVisualizer);
      analyser.getByteFrequencyData(dataArray);
      canvasCtx.fillStyle = '#111';
      canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
      
      const numBars = 64; // increased number of bars (was 16)
      const gap = 2; // increased spacing
      const step = Math.floor(bufferLength / numBars) || 1;
      let barHeights = [];
      
      // Compute each bar's height
      for (let i = 0; i < numBars; i++) {
        let sum = 0;
        for (let j = 0; j < step; j++){
          sum += dataArray[i * step + j];
        }
        let h = Math.min(sum / step / 2, canvas.height);
        barHeights.push(h);
      }
      
      // Determine active bars (height > 1)
      let activeIndices = [];
      barHeights.forEach((h, i) => { if (h > 1) activeIndices.push(i); });
      
      if (activeIndices.length > 0 && activeIndices.length < numBars) {
        // Recalculate width for active bars only
        const activeCount = activeIndices.length;
        const activeBarWidth = (canvas.width - gap * (activeCount - 1)) / activeCount;
        let currentX = 0;
        activeIndices.forEach((origIndex, orderIndex) => {
          const ratio = activeCount > 1 ? orderIndex / (activeCount - 1) : 0;
          canvasCtx.fillStyle = getGradientColor(ratio);
          canvasCtx.fillRect(currentX, canvas.height - barHeights[origIndex], activeBarWidth, barHeights[origIndex]);
          currentX += activeBarWidth + gap;
        });
      } else {
        // Draw all bars with default width and spacing
        const barWidth = (canvas.width - gap * (numBars - 1)) / numBars;
        let x = 0;
        for (let i = 0; i < numBars; i++) {
          const ratio = numBars > 1 ? i / (numBars - 1) : 0;
          canvasCtx.fillStyle = getGradientColor(ratio);
          canvasCtx.fillRect(x, canvas.height - barHeights[i], barWidth, barHeights[i]);
          x += barWidth + gap;
        }
      }
    }
    
    drawVisualizer();
    
    function playAudio() {
      if (!audioElement.src) {
        loadTrack(currentTrackIndex);
      }
      // Ensure AudioContext is resumed (required by some browsers)
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
      audioElement.play().catch(console.error);
      isPlaying = true;
      // Show now-playing text by removing invisibility
      document.querySelector(".now-playing").classList.remove("invisible");
      document.getElementById("play-pause").innerHTML = '<i class="fa fa-pause"></i>';
      setTimeout(() => {
        if (!audioElement.paused && !audioElement.currentTime) {
          loadTrack((currentTrackIndex + 1) % playlist.length);
        }
      }, 1000);
    }
    
    function loadTrack(index, autoplay = true) {
      if (playlist.length === 0) return;
      currentTrackIndex = index;
      audioElement.src = playlist[index].url;
      document.getElementById("track-title").textContent = `Playing: ${playlist[index].title}`;
      updatePlaylistHighlight();
      if (autoplay) {
        playAudio();
      } else {
        document.getElementById("play-pause").innerHTML = '<i class="fa fa-play"></i>';
        // Hide now-playing text but reserve space
        document.querySelector(".now-playing").classList.add("invisible");
      }
    }
    
    function updatePlaylistHighlight() {
      const items = document.querySelectorAll('.playlist-item');
      items.forEach((item, index) => {
        if (index === currentTrackIndex) {
          item.classList.add('playing');
        } else {
          item.classList.remove('playing');
        }
      });
    }
    
    document.getElementById("play-pause").addEventListener("click", () => {
      if (!isPlaying) {
        playAudio();
      } else {
        audioElement.pause();
        isPlaying = false;
        document.getElementById("play-pause").innerHTML = '<i class="fa fa-play"></i>';
        // Hide now-playing text while preserving layout space
        document.querySelector(".now-playing").classList.add("invisible");
      }
    });
    
    document.getElementById("next").addEventListener("click", () => {
      if (playlist.length > 0) {
        loadTrack((currentTrackIndex + 1) % playlist.length);
      }
    });
    
    document.getElementById("prev").addEventListener("click", () => {
      if (playlist.length > 0) {
        loadTrack((currentTrackIndex - 1 + playlist.length) % playlist.length);
      }
    });
    
    document.getElementById("volume-up").addEventListener("click", () => {
      if (audioElement.volume < 1) {
        audioElement.volume = Math.min(1, audioElement.volume + 0.1);
        document.getElementById("volume-level").textContent = Math.round(audioElement.volume * 100) + "%";
      }
    });
    
    document.getElementById("volume-down").addEventListener("click", () => {
      if (audioElement.volume > 0) {
        audioElement.volume = Math.max(0, audioElement.volume - 0.1);
        document.getElementById("volume-level").textContent = Math.round(audioElement.volume * 100) + "%";
      }
    });
    
    document.getElementById("load-local-btn").addEventListener("click", () => {
      document.getElementById("load-local").click();
    });
    
    document.getElementById("load-local").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const lines = e.target.result.split(/\r?\n/);
          playlist = [];
          document.getElementById("playlist").innerHTML = "";
          lines.forEach((line, index) => {
            if (line.startsWith("#EXTINF")) {
              const title = line.split(",")[1] || "Unknown Title";
              const url = lines[index + 1];
              if (url) {
                const trackIndex = playlist.length;
                playlist.push({ url, title });
                const entry = document.createElement("div");
                entry.textContent = `${trackIndex + 1}. ${title}`; // Modified: add numbering
                entry.classList.add("playlist-item");
                entry.addEventListener("click", () => loadTrack(trackIndex));
                document.getElementById("playlist").appendChild(entry);
              }
            }
          });
          if (playlist.length > 0) {
            loadTrack(0);
          }
        };
        reader.readAsText(file);
      }
    });
    
    document.getElementById("load-web-btn").addEventListener("click", () => {
      const url = prompt("Enter the URL of the M3U file:");
      if (url) {
        fetch(url)
          .then(response => {
            if (response.ok || response.status === 200 || response.status === 300) {
              return response.text();
            } else {
              throw new Error("Failed to load M3U file");
            }
          })
          .then(data => {
            const lines = data.split(/\r?\n/);
            playlist = [];
            document.getElementById("playlist").innerHTML = "";
            lines.forEach((line, index) => {
              if (line.startsWith("#EXTINF")) {
                const title = line.split(",")[1] || "Unknown Title";
                const url = lines[index + 1];
                if (url) {
                  const trackIndex = playlist.length;
                  playlist.push({ url, title });
                  const entry = document.createElement("div");
                  entry.textContent = `${trackIndex + 1}. ${title}`; // Modified: add numbering
                  entry.classList.add("playlist-item");
                  entry.addEventListener("click", () => loadTrack(trackIndex));
                  document.getElementById("playlist").appendChild(entry);
                }
              }
            });
            if (playlist.length > 0) {
              loadTrack(0);
            }
          })
          .catch(console.error);
      }
    });

    // Initialize playlist display and set default track (without autoplay)
    document.addEventListener("DOMContentLoaded", () => {
      const playlistContainer = document.getElementById("playlist");
      playlist.forEach((track, index) => {
        const entry = document.createElement("div");
        entry.textContent = `${index + 1}. ${track.title}`;
        entry.classList.add("playlist-item");
        entry.addEventListener("click", () => loadTrack(index));
        playlistContainer.appendChild(entry);
      });
      if (playlist.length > 0) {
        loadTrack(0, false);
      }
    });
  </script>
</body>
</html>
